<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Psychologist | Professional Dashboard</title>
    
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#6366f1',
                        secondary: '#94a3b8',
                        dark: '#0f172a',
                    }
                }
            }
        }
    </script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
:root {
    --primary: #6366f1;
    --primary-hover: #4f46e5;
    --bg-dark: #0f172a;
    --card-bg: rgba(30, 41, 59, 0.7);
    --border-color: rgba(255, 255, 255, 0.08);
}

body {
    font-family: 'Inter', sans-serif;
    background-color: var(--bg-dark);
    color: #f1f5f9;
    letter-spacing: -0.01em;
}

::-webkit-scrollbar {
    width: 5px;
}

::-webkit-scrollbar-track {
    background: transparent;
}

::-webkit-scrollbar-thumb {
    background: rgba(148, 163, 184, 0.2);
    border-radius: 10px;
}

::-webkit-scrollbar-thumb:hover {
    background: rgba(99, 102, 241, 0.5);
}

.glass-card {
    background: var(--card-bg);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border: 1px solid var(--border-color);
    box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
}

.glass-input {
    background: rgba(15, 23, 42, 0.6);
    border: 1px solid rgba(255, 255, 255, 0.1);
    transition: all 0.2s ease;
}

.glass-input:focus {
    border-color: var(--primary);
    box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
    background: rgba(15, 23, 42, 0.8);
}

h1, h2, h3 {
    font-weight: 700;
    letter-spacing: -0.02em;
}

.btn-premium {
    background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
    box-shadow: 0 4px 14px 0 rgba(99, 102, 241, 0.39);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.btn-premium:hover {
    transform: translateY(-1px);
    box-shadow: 0 6px 20px rgba(99, 102, 241, 0.45);
}

.transition-all {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.animate-fade-in {
    animation: fadeIn 0.4s ease-out forwards;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.6; }
}

.animate-pulse {
    animation: pulse 2.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
}

.backdrop-blur-sm {
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    background-color: rgba(0, 0, 0, 0.4);
}

input:focus, textarea:focus, select:focus {
    outline: none;
}

::selection {
    background: rgba(99, 102, 241, 0.3);
    color: #fff;
}

#chat-messages {
    scrollbar-width: thin;
    scrollbar-color: rgba(99, 102, 241, 0.3) transparent;
}

#chat-messages::-webkit-scrollbar {
    width: 6px;
}

#chat-messages::-webkit-scrollbar-track {
    background: transparent;
}

#chat-messages::-webkit-scrollbar-thumb {
    background: rgba(99, 102, 241, 0.3);
    border-radius: 10px;
}

#chat-messages::-webkit-scrollbar-thumb:hover {
    background: rgba(99, 102, 241, 0.5);
}

#chat-input:focus {
    background: rgba(30, 41, 59, 0.95);
}

#chat-messages > div {
    animation: slideInMessage 0.3s ease-out;
}

@keyframes slideInMessage {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.chat-input-wrapper {
    margin-left: 18rem; 
}

.chat-input-wrapper.sidebar-collapsed {
    margin-left: 6rem; 
}
    </style>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: radial-gradient(circle at top left, #1e293b, #0f172a);
            min-height: 100vh;
        }
        #root {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
    </style>
</head>
<body class="text-slate-200 antialiased selection:bg-indigo-500/30">

    <div id="root"></div>

    <script>
const API_BASE = 'http://localhost:8000/'; 
const CURRENT_CONSENT_VERSION = 'v1.0-2026';
const GOOGLE_CLIENT_ID = '420454232320-8mse8aona778k5jktdcs847c98bfsabu.apps.googleusercontent.com';

class ApiClient {
    constructor() {
        if (typeof window !== 'undefined') {
            this.accessToken = localStorage.getItem('access_token');
            this.refreshToken = localStorage.getItem('refresh_token');
        } else {
            this.accessToken = null;
            this.refreshToken = null;
        }
    }

    setTokens(access, refresh) {
        this.accessToken = access;
        this.refreshToken = refresh;
        localStorage.setItem('access_token', access);
        localStorage.setItem('refresh_token', refresh);
    }

    clearTokens() {
        this.accessToken = null;
        this.refreshToken = null;
        localStorage.removeItem('access_token');
        localStorage.removeItem('refresh_token');
    }

    async request(endpoint, options = {}) {
        let url = endpoint.startsWith('http') ? endpoint : `${API_BASE}${endpoint}`;
        const headers = { 'Content-Type': 'application/json', ...options.headers };
        if (this.accessToken) headers['Authorization'] = `Bearer ${this.accessToken}`;

        const config = { 
            ...options, 
            headers,
            credentials: 'include' 
        };
        
        console.log(`üåê API Request: ${options.method || 'GET'} ${url}`);

        try {
            let response = await fetch(url, config);
            console.log(`üì° Response status: ${response.status}`);
            
            if (response.status === 401 && this.refreshToken) {
                console.log('üîÑ Token expired, refreshing...');
                const refreshSuccess = await this.refreshAccessToken();
                if (refreshSuccess) {
                    config.headers['Authorization'] = `Bearer ${this.accessToken}`;
                    response = await fetch(url, config);
                    console.log(`üì° Retry response status: ${response.status}`);
                } else {
                    console.error('‚ùå Token refresh failed');
                    this.clearTokens();
                    window.location.reload(); 
                    throw new Error('Session expired');
                }
            }
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                console.error('‚ùå API Error:', errorData);
                throw new Error(errorData.detail || errorData.error || `Error: ${response.status}`);
            }
            const data = await response.json();
            console.log('‚úÖ Response data:', data);
            return data;
        } catch (error) { 
            console.error('‚ùå Request failed:', error);
            throw error; 
        }
    }

    async refreshAccessToken() {
        try {
            const response = await fetch(`${API_BASE}/refresh/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ refresh: this.refreshToken }),
                credentials: 'include'
            });
            if (response.ok) {
                const data = await response.json();
                this.setTokens(data.access, this.refreshToken); 
                return true;
            }
            return false;
        } catch (e) { return false; }
    }

    async checkServerConsent() {
        try {
            const response = await this.request('UserConsent/needs_new_consent/', {
                method: 'POST',
                body: JSON.stringify({}) 
            });
            
            if (response && typeof response.needs_consent !== 'undefined') {
                return response.needs_consent;
            }
            return true;
        } catch (error) {
            console.error("Failed to check consent status:", error);
            return true;
        }
    }
}

const api = new ApiClient();

function Icon({ name, size = 20, className = "" }) {
    const icons = {
        messageSquare: '<path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>',
        user: '<path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>',
        lock: '<rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/>',
        brain: '<path d="M9.5 2A2.5 2.5 0 0 1 12 4.5 2.5 2.5 0 0 1 14.5 2a2.5 2.5 0 0 1 2.5 2.5V7h-5V4.5A2.5 2.5 0 0 1 9.5 2z"/><path d="M12 7v4"/><path d="M12 11a4 4 0 0 0-4 4v3a2 2 0 0 0 2 2h4a2 2 0 0 0 2-2v-3a4 4 0 0 0-4-4z"/>',
        send: '<line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/>',
        plus: '<line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>',
        menu: '<line x1="4" y1="12" x2="20" y2="12"/><line x1="4" y1="6" x2="20" y2="6"/><line x1="4" y1="18" x2="20" y2="18"/>',
        x: '<line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>',
        dashboard: '<rect x="3" y="3" width="7" height="9"/><rect x="14" y="3" width="7" height="5"/><rect x="14" y="12" width="7" height="9"/><rect x="3" y="16" width="7" height="5"/>',
        chevronRight: '<polyline points="9 18 15 12 9 6"/>',
        chevronDown: '<polyline points="6 9 12 15 18 9"/>',
        users: '<path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/>',
        thumbsUp: '<path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"/>',
        logOut: '<path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/>',
        trash: '<polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>',
        alertCircle: '<circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>',
        stethoscope: '<path d="M4.8 2.3A.3.3 0 0 1 5 2h14a.3.3 0 0 1 .2.3v3.4a3 3 0 0 1-3 3H7.8a3 3 0 0 1-3-3V2.3Z"/><path d="M12 17v-8.3"/><path d="M8 17h8"/><path d="M12 17a4 4 0 0 1-4 4H5"/>',
        heartHandshake: '<path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/>',
        activity: '<polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>',
        barChart: '<line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/>',
        lightbulb: '<path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-1 1.5-2.5 1.5-4.1 0-3.2-2.8-5.7-6-5.7-3.2 0-6 2.5-6 5.7 0 1.6.5 3.1 1.5 4.1.8.8 1.3 1.5 1.5 2.5"/><path d="M9 18h6"/><path d="M10 22h4"/>'
    };
    
    const path = icons[name] || '';
    return `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${className}">${path}</svg>`;
}

function initializeGoogleSignIn() {
    if (typeof google !== 'undefined' && google.accounts) {
        google.accounts.id.initialize({
            client_id: GOOGLE_CLIENT_ID,
            callback: handleGoogleCallback,
            auto_select: false,
            cancel_on_tap_outside: true
        });
    }
}

function renderGoogleButton() {
    if (typeof google !== 'undefined' && google.accounts) {
        const buttonDiv = document.getElementById('google-signin-button');
        if (buttonDiv) {
            google.accounts.id.renderButton(
                buttonDiv,
                {
                    theme: 'filled_blue',
                    size: 'large',
                    width: buttonDiv.offsetWidth,
                    text: 'signin_with',
                    shape: 'pill'
                }
            );
        }
    }
}

async function handleGoogleCallback(response) {
    console.log('üîê Google Sign-In callback received');
    
    try {
        const data = await api.request('/auth/google/', {
            method: 'POST',
            body: JSON.stringify({ 
                id_token: response.credential 
            })
        });
        
        console.log('‚úÖ Google login response:', data);
        
        if (data.access && data.refresh) {
            api.setTokens(data.access, data.refresh);
            state.isAuthenticated = true;
            
            console.log('üîë Tokens saved, checking consent via server...');
            
            const needsConsent = await api.checkServerConsent();
            
            if (needsConsent) {
                console.log('‚ö†Ô∏è Server says consent needed');
                state.showConsent = true;
                render();
            } else {
                console.log('‚úÖ Server says consent valid, initializing app...');
                await initializeApp();
            }
        } else {
            throw new Error('Invalid response from server');
        }
    } catch (error) {
        console.error('‚ùå Google login error:', error);
        alert('Google Sign-In failed. Please try again.');
    }
}

function handleGoogleSignIn() {
    if (typeof google !== 'undefined' && google.accounts) {
        google.accounts.id.prompt();
    } else {
        alert('Google Sign-In is not loaded. Please refresh the page.');
    }
}

function ConsentModal({ onConsent }) {
    return `
        <div class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 animate-fade-in">
            <div class="glass-card rounded-3xl p-8 w-full max-w-2xl relative border-none">
                <div class="mb-6 border-b border-slate-700/50 pb-4">
                    <h2 class="text-3xl font-bold text-white mb-2 tracking-tight">Privacy & Consent</h2>
                    <p class="text-slate-400">Please review our privacy policy to continue using the platform.</p>
                </div>
                
                <div class="bg-slate-900/40 rounded-xl p-6 mb-8 max-h-64 overflow-y-auto border border-slate-700/50 inner-shadow">
                    <h3 class="text-lg font-semibold text-white mb-3">Data Collection Notice</h3>
                    <div class="text-sm text-slate-300 space-y-3 leading-relaxed">
                        <p>We collect and process the following information to ensure the best experience:</p>
                        <ul class="list-disc list-inside space-y-2 text-slate-400 ml-2">
                            <li>Your IP address and user agent for security purposes.</li>
                            <li>Chat conversations for real-time mental health analysis.</li>
                            <li>Dashboard metrics and personal wellness data.</li>
                            <li>Feedback and service ratings.</li>
                        </ul>
                        <p class="mt-4">This data is used solely to provide personalized mental health support.</p>
                        <p class="text-xs text-slate-500 mt-6 pt-4 border-t border-slate-700/50 font-mono">Consent Version: ${CURRENT_CONSENT_VERSION}</p>
                    </div>
                </div>

                <div class="flex gap-4">
                    <button onclick="handleConsent()" class="btn-premium flex-1 py-4 rounded-xl text-white font-bold text-lg tracking-wide hover:scale-[1.02] active:scale-95 transition-all">
                        I Accept & Continue
                    </button>
                </div>
            </div>
        </div>
    `;
}

function Login({ onLogin, onSwitchToRegister }) {
    return `
        <div class="min-h-screen flex items-center justify-center relative overflow-hidden px-4">
            <div class="absolute top-0 left-0 w-full h-full overflow-hidden -z-10">
                <div class="absolute top-[-10%] left-[-10%] w-[40%] h-[40%] bg-indigo-500/10 rounded-full blur-[100px]"></div>
                <div class="absolute bottom-[-10%] right-[-10%] w-[40%] h-[40%] bg-purple-500/10 rounded-full blur-[100px]"></div>
            </div>

            <div class="glass-card max-w-md w-full p-10 rounded-3xl animate-fade-in border-none">
                <div class="text-center mb-10">
                    <div class="mx-auto h-20 w-20 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl flex items-center justify-center mb-6 shadow-xl shadow-indigo-500/20">
                        ${Icon({ name: 'brain', size: 40, className: 'text-white' })}
                    </div>
                    <h2 class="text-3xl font-bold text-white tracking-tight">Welcome Back</h2>
                    <p class="mt-3 text-slate-400">Sign in to access your personal wellness dashboard</p>
                </div>

                <div class="mb-8">
                    <div id="google-signin-button" class="w-full h-[44px]"></div>
                </div>

                <div class="relative mb-8">
                    <div class="absolute inset-0 flex items-center">
                        <div class="w-full border-t border-slate-700/50"></div>
                    </div>
                    <div class="relative flex justify-center text-xs uppercase tracking-widest">
                        <span class="px-4 bg-[#141b2d] text-slate-500">Or continue with email</span>
                    </div>
                </div>

                <form class="space-y-6" onsubmit="handleLogin(event)">
                    <div class="space-y-5">
                        <div class="relative group">
                            <input type="text" id="username" required class="glass-input block w-full pl-12 pr-4 py-4 rounded-xl text-slate-200 placeholder-slate-500" placeholder="Username" />
                            <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none transition-colors group-focus-within:text-indigo-400 text-slate-500">
                                ${Icon({ name: 'user', size: 20 })}
                            </div>
                        </div>
                        <div class="relative group">
                            <input type="password" id="password" required class="glass-input block w-full pl-12 pr-4 py-4 rounded-xl text-slate-200 placeholder-slate-500" placeholder="Password" />
                            <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none transition-colors group-focus-within:text-indigo-400 text-slate-500">
                                ${Icon({ name: 'lock', size: 20 })}
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex items-center justify-end">
                        <button type="button" onclick="switchToRegister()" class="text-sm font-medium text-indigo-400 hover:text-indigo-300 transition-colors">Create an account</button>
                    </div>

                    <div id="login-error" class="hidden p-4 rounded-xl bg-red-500/10 text-red-400 text-sm text-center font-medium border border-red-500/20 animate-pulse"></div>

                    <button type="submit" class="btn-premium w-full py-4 px-4 text-sm font-bold rounded-xl text-white tracking-wide uppercase">
                        Sign In
                    </button>
                </form>
            </div>
        </div>
    `;
}

function Register() {
    return `
        <div class="min-h-screen flex items-center justify-center relative overflow-hidden px-4">
             <div class="absolute top-0 left-0 w-full h-full overflow-hidden -z-10">
                <div class="absolute top-[-10%] right-[-10%] w-[40%] h-[40%] bg-indigo-500/10 rounded-full blur-[100px]"></div>
                <div class="absolute bottom-[-10%] left-[-10%] w-[40%] h-[40%] bg-cyan-500/10 rounded-full blur-[100px]"></div>
            </div>

            <div class="glass-card max-w-md w-full p-10 rounded-3xl animate-fade-in border-none">
                <div class="text-center mb-8">
                    <h2 class="text-3xl font-bold text-white tracking-tight">Create Account</h2>
                    <p class="mt-2 text-slate-400">Join us to start your journey</p>
                </div>

                <div class="mb-8">
                    <div id="google-signin-button" class="w-full"></div>
                </div>

                <div class="relative mb-8">
                    <div class="absolute inset-0 flex items-center">
                        <div class="w-full border-t border-slate-700/50"></div>
                    </div>
                    <div class="relative flex justify-center text-xs uppercase tracking-widest">
                        <span class="px-4 bg-[#141b2d] text-slate-500">Or register with email</span>
                    </div>
                </div>

                <form class="space-y-5" onsubmit="handleRegister(event)">
                    <div class="space-y-4">
                        <input type="text" id="reg-username" required class="glass-input block w-full px-5 py-4 rounded-xl text-slate-200 placeholder-slate-500" placeholder="Username" />
                        <input type="email" id="reg-email" required class="glass-input block w-full px-5 py-4 rounded-xl text-slate-200 placeholder-slate-500" placeholder="Email Address" />
                        <input type="password" id="reg-password" required class="glass-input block w-full px-5 py-4 rounded-xl text-slate-200 placeholder-slate-500" placeholder="Password" />
                    </div>
                    
                    <div id="register-error" class="hidden text-red-400 text-sm text-center bg-red-500/10 p-2 rounded-lg"></div>
                    
                    <button type="submit" class="btn-premium w-full py-4 rounded-xl text-white font-bold tracking-wide uppercase">Register</button>
                    
                    <div class="text-center mt-6">
                        <button type="button" onclick="switchToLogin()" class="text-sm text-slate-400 hover:text-white transition-colors">
                            Already have an account? <span class="text-indigo-400">Login</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    `;
}

function Dashboard({ dashboardData }) {
    const rootContent = dashboardData?.content || {};
    const data = rootContent._personal_dashboard_data || {};
    
    const problems = data.common_problems || [];
    const positives = data.positive || [];
    const recommendations = data.recommendation || [];

    if (!dashboardData || (!problems.length && !positives.length && !recommendations.length)) {
        return `
            <div class="max-w-7xl mx-auto animate-fade-in">
                <div class="glass-card rounded-3xl p-16 text-center border-dashed border-2 border-slate-700/50">
                    <div class="w-20 h-20 bg-slate-800/50 rounded-full flex items-center justify-center mx-auto mb-6">
                        ${Icon({ name: 'activity', size: 40, className: 'text-slate-500' })}
                    </div>
                    <h2 class="text-3xl font-bold text-slate-200 mb-3">No Data Available Yet</h2>
                    <p class="text-slate-400 max-w-md mx-auto">Start a chat session to generate your personal wellness insights and recommendations.</p>
                </div>
            </div>
        `;
    }

    return `
        <div class="max-w-7xl mx-auto space-y-8 animate-fade-in">
            <div class="relative overflow-hidden rounded-3xl p-10 bg-gradient-to-r from-indigo-900/60 to-purple-900/60 border border-indigo-500/20 shadow-2xl">
                <div class="absolute top-0 right-0 p-10 opacity-10">
                     ${Icon({ name: 'activity', size: 120, className: 'text-white' })}
                </div>
                <div class="relative z-10">
                    <h1 class="text-4xl font-bold text-white mb-3">Wellness Overview</h1>
                    <p class="text-indigo-200 text-lg">Your AI-driven mental health insights for today.</p>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="glass-card rounded-3xl p-6 flex flex-col h-full hover:border-red-500/30 transition-all duration-300">
                    <div class="flex items-center gap-4 mb-6 pb-4 border-b border-slate-700/50">
                        <div class="p-3 bg-red-500/10 rounded-xl text-red-400">
                            ${Icon({ name: 'alertCircle', size: 24 })}
                        </div>
                        <h3 class="text-xl font-bold text-white">Areas to Address</h3>
                    </div>
                    <div class="space-y-4 flex-1">
                        ${problems.length > 0 ? problems.map(p => `
                            <div class="bg-red-500/5 border border-red-500/10 p-4 rounded-2xl hover:bg-red-500/10 transition-colors">
                                <h4 class="text-sm font-bold text-red-300 mb-2 uppercase tracking-wider">${p.problem || 'Identified Issue'}</h4>
                                <p class="text-sm text-slate-300 leading-relaxed">${p.description || p.suggestion || ''}</p>
                            </div>
                        `).join('') : '<p class="text-slate-500 text-center py-4">No issues identified.</p>'}
                    </div>
                </div>

                <div class="glass-card rounded-3xl p-6 flex flex-col h-full hover:border-yellow-500/30 transition-all duration-300">
                    <div class="flex items-center gap-4 mb-6 pb-4 border-b border-slate-700/50">
                         <div class="p-3 bg-yellow-500/10 rounded-xl text-yellow-400">
                            ${Icon({ name: 'lightbulb', size: 24 })}
                        </div>
                        <h3 class="text-xl font-bold text-white">Recommendations</h3>
                    </div>
                    <div class="space-y-4 flex-1">
                        ${recommendations.length > 0 ? recommendations.map(r => `
                            <div class="bg-yellow-500/5 border border-yellow-500/10 p-4 rounded-2xl hover:bg-yellow-500/10 transition-colors flex gap-3">
                                <span class="text-yellow-500 mt-1">‚Ä¢</span>
                                <p class="text-sm text-slate-300 leading-relaxed">${r.recommendation || r}</p>
                            </div>
                        `).join('') : '<p class="text-slate-500 text-center py-4">No recommendations available.</p>'}
                    </div>
                </div>

                <div class="glass-card rounded-3xl p-6 flex flex-col h-full hover:border-emerald-500/30 transition-all duration-300">
                    <div class="flex items-center gap-4 mb-6 pb-4 border-b border-slate-700/50">
                        <div class="p-3 bg-emerald-500/10 rounded-xl text-emerald-400">
                            ${Icon({ name: 'thumbsUp', size: 24 })}
                        </div>
                        <h3 class="text-xl font-bold text-white">Key Strengths</h3>
                    </div>
                    <div class="space-y-4 flex-1">
                        ${positives.length > 0 ? positives.map(p => `
                            <div class="bg-emerald-500/5 border border-emerald-500/10 p-4 rounded-2xl hover:bg-emerald-500/10 transition-colors">
                                <p class="text-sm text-emerald-200/90 font-medium">${p.positive || p}</p>
                            </div>
                        `).join('') : '<p class="text-slate-500 text-center py-4">No data available.</p>'}
                    </div>
                </div>
            </div>
        </div>
    `;
}

function TeamDashboard({ teamData, drillDownList }) {
    const contentArray = teamData?.content || [];
    const data = (Array.isArray(contentArray) && contentArray.length > 0) ? contentArray[0] : {};
    
    const problems = data.common_problems || [];
    const recommendations = data.recommendations || [];
    const policyChanges = data.policy_changes || [];
    
    const subordinates = drillDownList.slice(1);

    if (!teamData || (!problems.length && !recommendations.length && !policyChanges.length)) {
        return `
            <div class="max-w-7xl mx-auto animate-fade-in">
                <div class="glass-card rounded-3xl p-16 text-center mb-8 border-dashed border-2 border-slate-700/50">
                     <div class="w-20 h-20 bg-slate-800/50 rounded-full flex items-center justify-center mx-auto mb-6">
                        ${Icon({ name: 'users', size: 40, className: 'text-slate-500' })}
                    </div>
                    <h2 class="text-2xl font-bold text-slate-200 mb-2">Team Insights Unavailable</h2>
                    <p class="text-slate-400">Data will appear here as your team interacts with the platform.</p>
                </div>

                <div class="glass-card rounded-3xl p-8">
                    <h3 class="text-xl font-bold text-white mb-6 pl-2 border-l-4 border-indigo-500">Your Team</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        ${subordinates.length > 0 ? subordinates.map(member => `
                            <button onclick="viewSubordinateData('${member.node_id}')" class="group bg-slate-800/30 hover:bg-slate-800/60 p-5 rounded-2xl flex items-center justify-between transition-all border border-slate-700/50 hover:border-indigo-500/50 hover:shadow-lg">
                                <div class="flex items-center gap-4">
                                    <div class="w-12 h-12 bg-gradient-to-br from-indigo-500 to-purple-500 rounded-full flex items-center justify-center shadow-lg group-hover:scale-110 transition-transform">
                                        ${Icon({ name: 'user', size: 20, className: 'text-white' })}
                                    </div>
                                    <div class="text-left">
                                        <h4 class="text-sm font-bold text-white group-hover:text-indigo-300 transition-colors">${member.name}</h4>
                                        <p class="text-xs text-slate-400">${member.title}</p>
                                        ${member.has_team ? '<span class="inline-block mt-1.5 px-2 py-0.5 bg-purple-500/20 text-purple-300 text-[10px] font-bold uppercase rounded-md tracking-wider">Lead</span>' : ''}
                                    </div>
                                </div>
                                ${Icon({ name: 'chevronRight', size: 18, className: 'text-slate-600 group-hover:text-indigo-400 transition-colors' })}
                            </button>
                        `).join('') : '<p class="text-slate-500 col-span-3 text-center">No team members assigned.</p>'}
                    </div>
                </div>
            </div>
        `;
    }

    return `
        <div class="max-w-7xl mx-auto space-y-8 animate-fade-in">
            <div class="relative overflow-hidden rounded-3xl p-10 bg-gradient-to-r from-purple-900/60 to-pink-900/60 border border-purple-500/20 shadow-2xl">
                 <div class="absolute top-0 right-0 p-10 opacity-10">
                     ${Icon({ name: 'users', size: 120, className: 'text-white' })}
                </div>
                <div class="relative z-10">
                    <h1 class="text-4xl font-bold text-white mb-3">Team Health Overview</h1>
                    <p class="text-purple-200 text-lg">Aggregated insights to improve team dynamics and wellbeing.</p>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="glass-card rounded-3xl p-6 flex flex-col h-full hover:border-red-500/30 transition-all">
                    <div class="flex items-center gap-4 mb-6 pb-4 border-b border-slate-700/50">
                        <div class="p-3 bg-red-500/10 rounded-xl text-red-400">
                             ${Icon({ name: 'alertCircle', size: 24 })}
                        </div>
                        <h3 class="text-xl font-bold text-white">Common Issues</h3>
                    </div>
                    <div class="space-y-4 flex-1">
                        ${problems.length > 0 ? problems.map(p => `
                            <div class="bg-red-500/5 border border-red-500/10 p-4 rounded-2xl">
                                <h4 class="text-sm font-bold text-red-300 mb-2 uppercase tracking-wider">${p.problem || 'Issue'}</h4>
                                <p class="text-sm text-slate-300 leading-relaxed">${p.description || p.suggestion || ''}</p>
                            </div>
                        `).join('') : '<p class="text-slate-500 text-center py-4">No critical issues.</p>'}
                    </div>
                </div>

                <div class="glass-card rounded-3xl p-6 flex flex-col h-full hover:border-yellow-500/30 transition-all">
                    <div class="flex items-center gap-4 mb-6 pb-4 border-b border-slate-700/50">
                         <div class="p-3 bg-yellow-500/10 rounded-xl text-yellow-400">
                            ${Icon({ name: 'lightbulb', size: 24 })}
                        </div>
                        <h3 class="text-xl font-bold text-white">Action Plan</h3>
                    </div>
                    <div class="space-y-4 flex-1">
                        ${recommendations.length > 0 ? recommendations.map(r => `
                            <div class="bg-yellow-500/5 border border-yellow-500/10 p-4 rounded-2xl flex gap-3">
                                 <span class="text-yellow-500 mt-1">‚Ä¢</span>
                                <p class="text-sm text-slate-300 leading-relaxed">${r.recommendation || r}</p>
                            </div>
                        `).join('') : '<p class="text-slate-500 text-center py-4">No current recommendations.</p>'}
                    </div>
                </div>

                <div class="glass-card rounded-3xl p-6 flex flex-col h-full hover:border-blue-500/30 transition-all">
                    <div class="flex items-center gap-4 mb-6 pb-4 border-b border-slate-700/50">
                        <div class="p-3 bg-blue-500/10 rounded-xl text-blue-400">
                             ${Icon({ name: 'activity', size: 24 })}
                        </div>
                        <h3 class="text-xl font-bold text-white">Suggested Policies</h3>
                    </div>
                    <div class="space-y-4 flex-1">
                        ${policyChanges.length > 0 ? policyChanges.map(pc => `
                            <div class="bg-blue-500/5 border border-blue-500/10 p-4 rounded-2xl">
                                <h4 class="text-sm font-bold text-blue-300 mb-2 uppercase tracking-wider">${pc.title || 'Policy Idea'}</h4>
                                <p class="text-sm text-slate-300 leading-relaxed">${pc.description || pc.change || ''}</p>
                            </div>
                        `).join('') : '<p class="text-slate-500 text-center py-4">No policy changes needed.</p>'}
                    </div>
                </div>
            </div>

            <div class="glass-card rounded-3xl p-8">
                <h3 class="text-xl font-bold text-white mb-6 pl-2 border-l-4 border-indigo-500">Your Team</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    ${subordinates.length > 0 ? subordinates.map(member => `
                         <button onclick="viewSubordinateData('${member.node_id}')" class="group bg-slate-800/30 hover:bg-slate-800/60 p-5 rounded-2xl flex items-center justify-between transition-all border border-slate-700/50 hover:border-indigo-500/50 hover:shadow-lg">
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 bg-gradient-to-br from-indigo-500 to-purple-500 rounded-full flex items-center justify-center shadow-lg group-hover:scale-110 transition-transform">
                                    ${Icon({ name: 'user', size: 20, className: 'text-white' })}
                                </div>
                                <div class="text-left">
                                    <h4 class="text-sm font-bold text-white group-hover:text-indigo-300 transition-colors">${member.name}</h4>
                                    <p class="text-xs text-slate-400">${member.title}</p>
                                    ${member.has_team ? '<span class="inline-block mt-1.5 px-2 py-0.5 bg-purple-500/20 text-purple-300 text-[10px] font-bold uppercase rounded-md tracking-wider">Lead</span>' : ''}
                                </div>
                            </div>
                            ${Icon({ name: 'chevronRight', size: 18, className: 'text-slate-600 group-hover:text-indigo-400 transition-colors' })}
                        </button>
                    `).join('') : '<p class="text-slate-500 text-sm">No team members</p>'}
                </div>
            </div>
        </div>
    `;
}

function SubordinateDashboard({ subordinateData, memberInfo }) {
    const contentArray = subordinateData?.content || [];
    const data = (Array.isArray(contentArray) && contentArray.length > 0) ? contentArray[0] : {};
    
    const problems = data.common_problems || [];
    const recommendations = data.recommendations || [];
    const policyChanges = data.policy_changes || [];

    if (!subordinateData || (!problems.length && !recommendations.length && !policyChanges.length)) {
        return `
            <div class="max-w-7xl mx-auto animate-fade-in">
                <button onclick="goToTeamDashboard()" class="mb-6 px-4 py-2 bg-slate-800/50 text-slate-300 rounded-xl hover:bg-slate-700 hover:text-white transition-colors flex items-center gap-2 text-sm font-medium border border-slate-700/50">
                    <span>‚Üê</span> Back to Team
                </button>
                <div class="glass-card rounded-3xl p-16 text-center border-dashed border-2 border-slate-700/50">
                    <div class="w-20 h-20 bg-slate-800/50 rounded-full flex items-center justify-center mx-auto mb-6">
                        ${Icon({ name: 'lock', size: 40, className: 'text-slate-500' })}
                    </div>
                    <h2 class="text-2xl font-bold text-slate-200 mb-3">Restricted or Unavailable Data</h2>
                    <p class="text-slate-400 max-w-lg mx-auto">This member's data is either protected for privacy reasons or has not yet been generated.</p>
                </div>
            </div>
        `;
    }

    return `
        <div class="max-w-7xl mx-auto space-y-8 animate-fade-in">
            <button onclick="goToTeamDashboard()" class="px-4 py-2 bg-slate-800/50 text-slate-300 rounded-xl hover:bg-slate-700 hover:text-white transition-colors flex items-center gap-2 text-sm font-medium border border-slate-700/50">
                <span>‚Üê</span> Back to Team
            </button>

            <div class="relative overflow-hidden rounded-3xl p-10 bg-gradient-to-r from-cyan-900/60 to-blue-900/60 border border-cyan-500/20 shadow-2xl">
                <div class="absolute top-0 right-0 p-10 opacity-10">
                     ${Icon({ name: 'user', size: 120, className: 'text-white' })}
                </div>
                <div class="relative z-10">
                    <h1 class="text-4xl font-bold text-white mb-2">${memberInfo?.name || 'Team Member'}</h1>
                    <p class="text-cyan-200 text-lg flex items-center gap-2">
                        <span class="opacity-70">Role:</span> 
                        <span class="font-semibold bg-cyan-500/20 px-3 py-1 rounded-lg border border-cyan-500/30 text-sm">${memberInfo?.title || 'Team Member'}</span>
                    </p>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                 <div class="glass-card rounded-3xl p-6 flex flex-col h-full hover:border-red-500/30 transition-all">
                    <div class="flex items-center gap-4 mb-6 pb-4 border-b border-slate-700/50">
                        <div class="p-3 bg-red-500/10 rounded-xl text-red-400">
                             ${Icon({ name: 'alertCircle', size: 24 })}
                        </div>
                        <h3 class="text-xl font-bold text-white">Challenges</h3>
                    </div>
                    <div class="space-y-4 flex-1">
                        ${problems.length > 0 ? problems.map(p => `
                            <div class="bg-red-500/5 border border-red-500/10 p-4 rounded-2xl">
                                <h4 class="text-sm font-bold text-red-300 mb-2 uppercase tracking-wider">${p.problem || 'Issue'}</h4>
                                <p class="text-sm text-slate-300 leading-relaxed">${p.description || p.suggestion || ''}</p>
                            </div>
                        `).join('') : '<p class="text-slate-500 text-center py-4">No challenges identified.</p>'}
                    </div>
                </div>

                <div class="glass-card rounded-3xl p-6 flex flex-col h-full hover:border-yellow-500/30 transition-all">
                     <div class="flex items-center gap-4 mb-6 pb-4 border-b border-slate-700/50">
                         <div class="p-3 bg-yellow-500/10 rounded-xl text-yellow-400">
                            ${Icon({ name: 'lightbulb', size: 24 })}
                        </div>
                        <h3 class="text-xl font-bold text-white">Guidance</h3>
                    </div>
                    <div class="space-y-4 flex-1">
                        ${recommendations.length > 0 ? recommendations.map(r => `
                            <div class="bg-yellow-500/5 border border-yellow-500/10 p-4 rounded-2xl flex gap-3">
                                <span class="text-yellow-500 mt-1">‚Ä¢</span>
                                <p class="text-sm text-slate-300 leading-relaxed">${r.recommendation || r}</p>
                            </div>
                        `).join('') : '<p class="text-slate-500 text-center py-4">No specific guidance.</p>'}
                    </div>
                </div>

                <div class="glass-card rounded-3xl p-6 flex flex-col h-full hover:border-blue-500/30 transition-all">
                     <div class="flex items-center gap-4 mb-6 pb-4 border-b border-slate-700/50">
                        <div class="p-3 bg-blue-500/10 rounded-xl text-blue-400">
                             ${Icon({ name: 'activity', size: 24 })}
                        </div>
                        <h3 class="text-xl font-bold text-white">Impact</h3>
                    </div>
                    <div class="space-y-4 flex-1">
                        ${policyChanges.length > 0 ? policyChanges.map(pc => `
                            <div class="bg-blue-500/5 border border-blue-500/10 p-4 rounded-2xl">
                                <h4 class="text-sm font-bold text-blue-300 mb-2 uppercase tracking-wider">${pc.title || 'Policy'}</h4>
                                <p class="text-sm text-slate-300 leading-relaxed">${pc.description || pc.change || ''}</p>
                            </div>
                        `).join('') : '<p class="text-slate-500 text-center py-4">No policy impact.</p>'}
                    </div>
                </div>
            </div>
        </div>
    `;
}

function ChatInterface({ messages, activeSessionId }) {
    return `
        <div id="chat-messages" class="flex-1 overflow-y-auto px-6 py-8 space-y-6 pb-40 max-w-4xl mx-auto w-full">
            ${messages.length === 0 ? `
                <div class="flex items-center justify-center h-full">
                    <div class="text-center text-slate-500 space-y-4">
                        ${Icon({ name: 'messageSquare', size: 48, className: 'mx-auto mb-4 opacity-40' })}
                        <p class="text-lg">Start a conversation</p>
                    </div>
                </div>
            ` : messages.map(msg => `
                <div class="flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}">
                    <div class="${msg.role === 'user' 
                        ? 'bg-indigo-600 text-white rounded-2xl rounded-br-none' 
                        : 'bg-[#1e293b] text-slate-200 rounded-2xl rounded-bl-none'} 
                        px-5 py-3 max-w-[85%] text-[15px] shadow-sm">
                        <p class="whitespace-pre-wrap leading-relaxed">${msg.content}</p>
                    </div>
                </div>
            `).join('')}
            <div id="streaming-message"></div>
        </div>
        
        <div class="fixed bottom-0 left-0 right-0 bg-[#0f172a]/95 backdrop-blur-md border-t border-slate-800/50 px-6 py-6 z-40">
            <div class="chat-input-wrapper ${state.sidebarCollapsed ? 'sidebar-collapsed' : ''} transition-all duration-300">
                <form onsubmit="handleSendMessage(event)" class="flex items-center gap-3 max-w-4xl mx-auto w-full">
                    <input 
                        type="text" 
                        id="chat-input" 
                        placeholder="Type your message..." 
                        class="flex-1 px-6 py-4 bg-[#1e293b] border border-slate-700/50 rounded-full text-slate-200 placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-indigo-500/50 focus:border-indigo-500/50 transition-all text-[15px]" 
                    />
                    <button 
                        type="submit" 
                        class="p-4 bg-indigo-600 hover:bg-indigo-500 rounded-full transition-all hover:scale-105 active:scale-95 shadow-lg shadow-indigo-600/20 flex-shrink-0">
                        ${Icon({ name: 'send', size: 20, className: 'text-white' })}
                    </button>
                </form>
            </div>
        </div>
    `;
}

function FeedbackForm() {
    return `
        <div class="max-w-2xl mx-auto animate-fade-in pt-10">
            <div class="glass-card rounded-3xl p-10 border border-slate-700/50 shadow-2xl relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500"></div>
                
                <h2 class="text-3xl font-bold text-white mb-2">We Value Your Feedback</h2>
                <p class="text-slate-400 mb-8">Help us improve your experience by sharing your thoughts.</p>
                
                <form onsubmit="handleFeedbackSubmit(event)" class="space-y-6">
                    <div>
                        <label class="block text-sm font-bold text-slate-300 mb-2 uppercase tracking-wide">Your Message</label>
                        <textarea id="feedback-text" rows="6" required class="glass-input w-full px-5 py-4 rounded-xl text-slate-200 placeholder-slate-500 focus:ring-2 focus:ring-indigo-500/50 resize-none" placeholder="Tell us what you think..."></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-slate-300 mb-2 uppercase tracking-wide">Rating</label>
                        <div class="relative">
                            <select id="feedback-rating" class="glass-input w-full px-5 py-4 rounded-xl text-slate-200 appearance-none cursor-pointer">
                                <option value="5">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ - Excellent</option>
                                <option value="4">‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ - Good</option>
                                <option value="3">‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ - Average</option>
                                <option value="2">‚òÖ‚òÖ‚òÜ‚òÜ‚òÜ - Poor</option>
                                <option value="1">‚òÖ‚òÜ‚òÜ‚òÜ‚òÜ - Very Poor</option>
                            </select>
                            <div class="absolute right-5 top-1/2 -translate-y-1/2 pointer-events-none text-slate-400">
                                ${Icon({ name: 'chevronDown', size: 16 })}
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="btn-premium w-full py-4 rounded-xl text-white font-bold text-lg tracking-wide uppercase mt-4">
                        Submit Feedback
                    </button>
                </form>
                <div id="feedback-success" class="hidden mt-6 p-4 bg-emerald-500/10 border border-emerald-500/20 text-emerald-400 rounded-xl text-center font-medium animate-pulse"></div>
            </div>
        </div>
    `;
}

let state = {
    isAuthenticated: false,
    currentView: 'login',
    showConsent: false,
    sessions: [],
    activeSessionId: null,
    messages: [],
    drillDownList: [],
    hasTeam: false,
    dashboardData: null,
    teamData: null,
    subordinateData: null,
    currentSubordinateInfo: null,
    sidebarCollapsed: true,
    newChatModalOpen: false
};

async function handleConsent() {
    console.log('üìù Submitting consent...');
    try {
        await api.request('/UserConsent/', {
            method: 'POST',
            body: JSON.stringify({ consent_version: CURRENT_CONSENT_VERSION })
        });
        console.log('‚úÖ Consent accepted');
        state.showConsent = false;
        
        await initializeApp();
    } catch (error) {
        console.error('‚ùå Consent error:', error);
        alert('Error submitting consent. Please try again.');
    }
}

async function handleLogin(event) {
    event.preventDefault();
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;
    const errorDiv = document.getElementById('login-error');
    
    console.log('üîê Attempting login...');
    
    try {
        const data = await api.request('/login/', {
            method: 'POST',
            body: JSON.stringify({ username, password })
        });
        
        console.log('‚úÖ Login response:', data);
        
        if (data.access && data.refresh) {
            api.setTokens(data.access, data.refresh);
            state.isAuthenticated = true;
            
            console.log('üîë Tokens saved, checking consent via server...');
            
            const needsConsent = await api.checkServerConsent();
            
            if (needsConsent) {
                console.log('‚ö†Ô∏è Server says consent needed');
                state.showConsent = true;
                render();
            } else {
                console.log('‚úÖ Server says consent valid, initializing app...');
                await initializeApp();
            }

        } else {
            throw new Error('Invalid response from server');
        }
    } catch (error) {
        console.error('‚ùå Login error:', error);
        errorDiv.textContent = 'Invalid credentials or server error';
        errorDiv.classList.remove('hidden');
    }
}

async function handleRegister(event) {
    event.preventDefault();
    const username = document.getElementById('reg-username').value;
    const email = document.getElementById('reg-email').value;
    const password = document.getElementById('reg-password').value;
    const errorDiv = document.getElementById('register-error');
    
    try {
        await api.request('/register/', {
            method: 'POST',
            body: JSON.stringify({ username, email, password })
        });
        alert('Registration successful! Please login.');
        switchToLogin();
    } catch (error) {
        errorDiv.textContent = error.message || 'Registration failed';
        errorDiv.classList.remove('hidden');
    }
}

function switchToRegister() {
    state.currentView = 'register';
    render();
}

function switchToLogin() {
    state.currentView = 'login';
    render();
}

async function initializeApp() {
    console.log('üöÄ Starting app initialization...');
    
    try {
        console.log('üìã Fetching drill down list...');
        const drillDownData = await api.request('/UserDrillDown/');
        console.log('‚úÖ Drill down data:', drillDownData);
        
        if (drillDownData && drillDownData.length > 0) {
            state.drillDownList = drillDownData[0].content || [];
            state.hasTeam = state.drillDownList.length > 0 && state.drillDownList[0].has_team;
            console.log('üë• Has team:', state.hasTeam);
        }

        console.log('üí¨ Fetching chat sessions...');
        const sessions = await api.request('/Chats/');
        console.log('‚úÖ Chat sessions:', sessions);
        
        if (Array.isArray(sessions)) {
            state.sessions = sessions.sort((a, b) => {
                return new Date(b.last_updated) - new Date(a.last_updated);
            });
        } else {
            state.sessions = [];
        }

        console.log('üìä Fetching personal dashboard...');
        const dashboardArr = await api.request('/UserDashboard/');
        console.log('‚úÖ Dashboard data:', dashboardArr);
        
        if (dashboardArr && dashboardArr.length > 0) {
            state.dashboardData = dashboardArr[0];
        }

        state.currentView = 'dashboard';
        console.log('‚úÖ Initialization complete!');
        render();
    } catch (error) {
        console.error('‚ùå Initialization error:', error);
        console.error('Error details:', error.message);
        state.currentView = 'dashboard';
        render();
    }
}

async function loadChatHistory(sessionId) {
    try {
        // 1. Fetch the data
        const chatData = await api.request(`/ChatData/?chat_id=${sessionId}`);
        
        // 2. Validate we received a list with at least one session object
        if (Array.isArray(chatData) && chatData.length > 0) {
            
            // 3. Extract the raw history list from the first result
            const rawHistory = chatData[0].content || [];

            // 4. Normalize the data (Fixing the key mismatch)
            // Backend saves as 'message', but sometimes you might expect 'content'
            state.messages = rawHistory.map(msg => ({
                role: msg.role,
                // Check 'message' first (per your save logic), fall back to 'content'
                content: msg.message || msg.content || "" 
            }));

        } else {
            state.messages = [];
        }
        
        render();
    } catch (error) {
        console.error('Error loading chat:', error);
        state.messages = [];
        render();
    }
}

async function handleSendMessage(event) {
    event.preventDefault();
    const input = document.getElementById('chat-input');
    const message = input.value.trim();
    
    if (!message) return;

    if (!state.activeSessionId) {
        try {
            const newSession = await api.request('/Chats/', {
                method: 'POST',
                body: JSON.stringify({
                    title: message.substring(0, 30) + '...',
                    AiMode: 'therapy'
                })
            });
            state.activeSessionId = newSession.id;
            
            const sessions = await api.request('/Chats/');
            state.sessions = sessions.sort((a, b) => {
                return new Date(b.last_updated) - new Date(a.last_updated);
            });
        } catch (error) {
            console.error('Error creating session:', error);
            return;
        }
    }

    state.messages.push({ role: 'user', content: message });
    input.value = '';
    render();

    try {
        const response = await fetch(`${API_BASE}/ChatData/continue_chat/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${api.accessToken}`
            },
            body: JSON.stringify({
                prompt: message,
                mode: 'therapy',
                ChatID: state.activeSessionId
            })
        });


        if (!response.ok) {
            throw new Error(`Server Error: ${response.statusText}`);
        }

        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let aiResponse = '';
        
        const streamingDiv = document.getElementById('streaming-message');
        
        streamingDiv.innerHTML = `
            <div class="flex justify-start animate-fade-in">
                <div class="bg-[#1e293b] text-slate-200 rounded-2xl rounded-bl-none px-5 py-3 max-w-[85%] text-[15px] shadow-sm">
                    <p class="whitespace-pre-wrap leading-relaxed inline" id="ai-response"></p>
                    <span class="inline-block w-1.5 h-4 ml-1 align-middle bg-indigo-500 animate-pulse rounded-sm"></span>
                </div>
            </div>
        `;
        
        while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            
            const chunk = decoder.decode(value);
            aiResponse += chunk;
            document.getElementById('ai-response').textContent = aiResponse;
            
            const chatMessages = document.getElementById('chat-messages');
            if(chatMessages) chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        state.messages.push({ role: 'assistant', content: aiResponse });
        
        const sessions = await api.request('/Chats/');
        state.sessions = sessions.sort((a, b) => {
            return new Date(b.last_updated) - new Date(a.last_updated);
        });
        
        render();
    } catch (error) {
        console.error('Error sending message:', error);
    }
}

async function handleFeedbackSubmit(event) {
    event.preventDefault();
    const feedback = document.getElementById('feedback-text').value;
    const rating = document.getElementById('feedback-rating').value;
    
    try {
        await api.request('/UserFeedback/', {
            method: 'POST',
            body: JSON.stringify({ feedback, rating: parseInt(rating) })
        });
        
        document.getElementById('feedback-success').textContent = 'Thank you for your feedback!';
        document.getElementById('feedback-success').classList.remove('hidden');
        document.getElementById('feedback-text').value = '';
        
        setTimeout(() => {
            document.getElementById('feedback-success').classList.add('hidden');
        }, 3000);
    } catch (error) {
        console.error('Feedback error:', error);
    }
}

async function handleHumanHelp() {
    if (!confirm('Request human therapist assistance? Your information will be shared with our support team.')) {
        return;
    }
    
    try {
        const userData = await api.request('/UserDrillDown/');
        const userName = userData[0]?.content[0]?.name || 'Anonymous';
        
        await api.request('/TherapistNeeded/', {
            method: 'POST',
            body: JSON.stringify({ users_in_need: [userName] })
        });
        
        alert('Your request has been submitted. A human therapist will contact you soon.');
    } catch (error) {
        console.error('Human help error:', error);
        alert('Failed to submit request. Please try again.');
    }
}

function handleLogout() {
    api.clearTokens();
    state = {
        isAuthenticated: false,
        currentView: 'login',
        showConsent: false,
        sessions: [],
        activeSessionId: null,
        messages: [],
        drillDownList: [],
        hasTeam: false,
        dashboardData: null,
        teamData: null,
        subordinateData: null,
        currentSubordinateInfo: null,
        sidebarCollapsed: true,
        newChatModalOpen: false
    };
    render();
}

async function navigateTo(view) {
    state.currentView = view;
    
    if (view === 'teamDashboard' && state.drillDownList.length > 0) {
        const userId = state.drillDownList[0].node_id;
        try {
            const teamData = await api.request(`/DashBoardData/${userId}/health_dashboard/`);
            state.teamData = teamData;
        } catch (error) {
            console.error('Error loading team dashboard:', error);
            state.teamData = null;
        }
    }
    
    render();
}

async function viewSubordinateData(nodeId) {
    try {
        const memberInfo = state.drillDownList.find(m => m.node_id === nodeId);
        state.currentSubordinateInfo = memberInfo;
        
        const data = await api.request(`/DashBoardData/${nodeId}/health_dashboard/`);
        state.subordinateData = data;
        
        state.currentView = 'subordinateDashboard';
        render();
    } catch (error) {
        console.error('Error loading subordinate data:', error);
        state.subordinateData = null;
        state.currentView = 'subordinateDashboard';
        render();
    }
}

function goToTeamDashboard() {
    navigateTo('teamDashboard');
}

function handleSessionClick(sessionId) {
    state.activeSessionId = sessionId;
    state.currentView = 'chat';
    loadChatHistory(sessionId);
}

async function handleDeleteChat(sessionId) {
    if (!confirm('Delete this chat session?')) return;
    
    try {
        await api.request(`/Chats/${sessionId}/`, { method: 'DELETE' });
        
        const sessions = await api.request('/Chats/');
        state.sessions = sessions.sort((a, b) => {
            return new Date(b.last_updated) - new Date(a.last_updated);
        });
        
        if (state.activeSessionId === sessionId) {
            state.activeSessionId = null;
            state.messages = [];
        }
        render();
    } catch (error) {
        console.error('Delete error:', error);
    }
}

function toggleSidebar() {
    state.sidebarCollapsed = !state.sidebarCollapsed;
    render();
}

function openNewChatModal() {
    state.newChatModalOpen = true;
    render();
}

function closeNewChatModal() {
    state.newChatModalOpen = false;
    render();
}

async function handleCreateNewChat(event) {
    event.preventDefault();
    const title = document.getElementById('new-chat-title').value;
    const mode = document.getElementById('new-chat-mode').value;
    
    try {
        const newSession = await api.request('/Chats/', {
            method: 'POST',
            body: JSON.stringify({ title, AiMode: mode })
        });
        
        const sessions = await api.request('/Chats/');
        state.sessions = sessions.sort((a, b) => {
            return new Date(b.last_updated) - new Date(a.last_updated);
        });
        
        state.activeSessionId = newSession.id;
        state.messages = [];
        state.currentView = 'chat';
        state.newChatModalOpen = false;
        render();
    } catch (error) {
        console.error('Create chat error:', error);
    }
}

function render() {
    const root = document.getElementById('root');
    
    if (state.showConsent) {
        root.innerHTML = ConsentModal({ onConsent: handleConsent });
        return;
    }
    
    if (!state.isAuthenticated) {
        if (state.currentView === 'register') {
            root.innerHTML = Register();
        } else {
            root.innerHTML = Login({ onLogin: handleLogin, onSwitchToRegister: switchToRegister });
        }
        
        setTimeout(() => {
            initializeGoogleSignIn();
            renderGoogleButton();
        }, 100);
        
        return;
    }

    let mainContent = '';
    switch (state.currentView) {
        case 'dashboard':
            mainContent = Dashboard({ dashboardData: state.dashboardData });
            break;
        case 'teamDashboard':
            mainContent = TeamDashboard({ teamData: state.teamData, drillDownList: state.drillDownList });
            break;
        case 'subordinateDashboard':
            mainContent = SubordinateDashboard({ subordinateData: state.subordinateData, memberInfo: state.currentSubordinateInfo });
            break;
        case 'chat':
            mainContent = ChatInterface({ messages: state.messages, activeSessionId: state.activeSessionId });
            break;
        case 'feedback':
            mainContent = FeedbackForm();
            break;
    }

    root.innerHTML = `
        <div class="flex h-screen bg-[#0f172a] text-slate-200 font-sans overflow-hidden selection:bg-indigo-500/30">
             <aside class="${state.sidebarCollapsed ? 'w-24' : 'w-72'} glass-card border-y-0 border-l-0 border-r border-slate-700/30 flex flex-col p-5 transition-all duration-300 z-50">
                <div class="flex items-center justify-between mb-10">
                    ${!state.sidebarCollapsed ? `
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-lg bg-indigo-500 flex items-center justify-center shadow-lg shadow-indigo-500/30">
                                ${Icon({ name: 'brain', size: 18, className: 'text-white' })}
                            </div>
                            <h1 class="text-lg font-bold text-white tracking-tight">AI Psychologist</h1>
                        </div>
                    ` : `
                         <div class="w-10 h-10 rounded-xl bg-indigo-500 flex items-center justify-center shadow-lg mx-auto">
                            ${Icon({ name: 'brain', size: 20, className: 'text-white' })}
                        </div>
                    `}
                    ${!state.sidebarCollapsed ? `
                    <button onclick="toggleSidebar()" class="p-2 hover:bg-slate-700/50 rounded-lg transition-colors text-slate-400 hover:text-white">
                        ${Icon({ name: 'menu', size: 20 })}
                    </button>
                    ` : ''}
                </div>

                ${state.sidebarCollapsed ? `
                     <button onclick="toggleSidebar()" class="mb-8 w-full p-3 hover:bg-slate-700/50 rounded-xl transition-colors text-slate-400 hover:text-white flex justify-center">
                        ${Icon({ name: 'menu', size: 20 })}
                    </button>
                ` : ''}

                <div class="space-y-3">
                    <button onclick="navigateTo('dashboard')" class="w-full py-3 rounded-xl flex items-center px-4 ${state.currentView === 'dashboard' ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-600/20' : 'text-slate-400 hover:bg-slate-800/60 hover:text-white'} transition-all group">
                        ${Icon({ name: 'dashboard', size: 20, className: state.currentView === 'dashboard' ? 'text-white' : 'group-hover:scale-110 transition-transform' })}
                        ${!state.sidebarCollapsed ? '<span class="ml-4 text-sm font-semibold tracking-wide">Dashboard</span>' : ''}
                    </button>

                    ${state.hasTeam ? `
                        <button onclick="navigateTo('teamDashboard')" class="w-full py-3 rounded-xl flex items-center px-4 ${state.currentView === 'teamDashboard' ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-600/20' : 'text-slate-400 hover:bg-slate-800/60 hover:text-white'} transition-all group">
                            ${Icon({ name: 'users', size: 20, className: state.currentView === 'teamDashboard' ? 'text-white' : 'group-hover:scale-110 transition-transform' })}
                            ${!state.sidebarCollapsed ? '<span class="ml-4 text-sm font-semibold tracking-wide">Team View</span>' : ''}
                        </button>
                    ` : ''}

                    <button onclick="openNewChatModal()" class="w-full py-3 rounded-xl flex items-center px-4 ${state.currentView === 'chat' ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-600/20' : 'text-slate-400 hover:bg-slate-800/60 hover:text-white'} transition-all group">
                        ${Icon({ name: 'messageSquare', size: 20, className: state.currentView === 'chat' ? 'text-white' : 'group-hover:scale-110 transition-transform' })}
                        ${!state.sidebarCollapsed ? '<span class="ml-4 text-sm font-semibold tracking-wide">New Chat</span>' : ''}
                    </button>

                    <button onclick="navigateTo('feedback')" class="w-full py-3 rounded-xl flex items-center px-4 ${state.currentView === 'feedback' ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-600/20' : 'text-slate-400 hover:bg-slate-800/60 hover:text-white'} transition-all group">
                        ${Icon({ name: 'thumbsUp', size: 20, className: state.currentView === 'feedback' ? 'text-white' : 'group-hover:scale-110 transition-transform' })}
                        ${!state.sidebarCollapsed ? '<span class="ml-4 text-sm font-semibold tracking-wide">Feedback</span>' : ''}
                    </button>
                </div>

                ${!state.sidebarCollapsed ? `
                    <div class="mt-8 flex-1 overflow-y-auto pr-2 custom-scrollbar">
                        <h3 class="px-2 text-xs font-bold text-slate-500 uppercase tracking-wider mb-4">Recent Sessions</h3>
                        <div class="space-y-1">
                            ${state.sessions.map(session => {
                                const date = new Date(session.last_updated);
                                const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                                return `
                                <div class="group relative flex items-center">
                                    <button onclick="handleSessionClick('${session.id}')" class="flex-1 rounded-xl px-4 py-3 ${state.activeSessionId === session.id ? 'bg-slate-800/80 text-white border border-slate-700' : 'text-slate-400 hover:bg-slate-800/50 hover:text-slate-200'} transition-all text-left w-full overflow-hidden">
                                        <div class="flex items-center gap-3">
                                            <div class="min-w-[4px] h-4 rounded-full ${state.activeSessionId === session.id ? 'bg-indigo-500' : 'bg-slate-600'}"></div>
                                            <span class="text-sm truncate font-medium">${session.title}</span>
                                        </div>
                                        <div class="ml-4 mt-1 text-[10px] text-slate-600 font-mono pl-1">${dateStr}</div>
                                    </button>
                                    <button onclick="handleDeleteChat('${session.id}')" class="absolute right-2 p-2 text-slate-600 hover:text-red-400 rounded-lg hover:bg-red-500/10 transition-colors opacity-0 group-hover:opacity-100">
                                        ${Icon({ name: 'trash', size: 14 })}
                                    </button>
                                </div>
                            `}).join('')}
                            ${state.sessions.length === 0 ? '<div class="px-4 py-8 border border-dashed border-slate-800 rounded-xl text-center"><p class="text-xs text-slate-500">No active sessions</p></div>' : ''}
                        </div>
                    </div>
                ` : ''}

                <div class="mt-auto border-t border-slate-700/30 pt-6 space-y-3">
                    <button onclick="handleHumanHelp()" class="w-full py-3 rounded-xl flex items-center px-4 text-slate-400 hover:bg-rose-500/10 hover:text-rose-400 transition-colors group border border-transparent hover:border-rose-500/20">
                        ${Icon({ name: 'heartHandshake', size: 20, className: 'group-hover:scale-110 transition-transform' })}
                        ${!state.sidebarCollapsed ? '<span class="ml-4 text-sm font-semibold tracking-wide">Human Help</span>' : ''}
                    </button>
                    <button onclick="handleLogout()" class="w-full py-3 rounded-xl flex items-center px-4 text-slate-400 hover:bg-slate-800/80 hover:text-white transition-colors group">
                        ${Icon({ name: 'logOut', size: 20, className: 'group-hover:scale-110 transition-transform' })}
                        ${!state.sidebarCollapsed ? '<span class="ml-4 text-sm font-semibold tracking-wide">Logout</span>' : ''}
                    </button>
                </div>
            </aside>

            <main class="flex-1 overflow-y-auto relative bg-[#0f172a]">
                <div class="absolute top-0 left-0 w-full h-[500px] bg-indigo-900/10 blur-[120px] pointer-events-none"></div>
                
                <div class="relative z-10 p-8 min-h-full">
                    ${mainContent}
                </div>
            </main>
        </div>

        ${state.newChatModalOpen ? `
            <div class="fixed inset-0 bg-black/80 backdrop-blur-md flex items-center justify-center z-[100] animate-fade-in">
                <div class="glass-card bg-[#1e293b] rounded-3xl p-8 w-full max-w-md border border-slate-700/50 shadow-2xl relative">
                    <button onclick="closeNewChatModal()" class="absolute top-6 right-6 text-slate-400 hover:text-white transition-colors">
                        ${Icon({ name: 'x', size: 24 })}
                    </button>
                    
                    <div class="mb-8">
                        <div class="w-14 h-14 bg-indigo-500/20 rounded-2xl flex items-center justify-center mb-4 text-indigo-400">
                             ${Icon({ name: 'messageSquare', size: 28 })}
                        </div>
                        <h2 class="text-2xl font-bold text-white">Start New Session</h2>
                        <p class="text-slate-400 text-sm mt-1">Choose your preferred AI companion mode.</p>
                    </div>

                    <form onsubmit="handleCreateNewChat(event)" class="space-y-6">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase tracking-widest mb-2">Session Name</label>
                            <input type="text" id="new-chat-title" required class="glass-input w-full px-5 py-4 rounded-xl text-white placeholder-slate-500 focus:ring-2 focus:ring-indigo-500" placeholder="e.g., Weekly Check-in..." />
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase tracking-widest mb-2">Select Mode</label>
                            <div class="grid grid-cols-2 gap-3">
                                <label class="cursor-pointer">
                                    <input type="radio" name="chat-mode" value="therapy" class="peer hidden" checked onchange="document.getElementById('new-chat-mode').value = this.value">
                                    <div class="p-4 rounded-xl border border-slate-700 bg-slate-800/50 peer-checked:bg-indigo-600 peer-checked:border-indigo-500 peer-checked:text-white text-slate-400 transition-all text-center h-full">
                                        <div class="font-bold text-sm mb-1">Therapy AI</div>
                                        <div class="text-[10px] opacity-70">Clinical Approach</div>
                                    </div>
                                </label>
                                <label class="cursor-pointer">
                                    <input type="radio" name="chat-mode" value="counsellor" class="peer hidden" onchange="document.getElementById('new-chat-mode').value = this.value">
                                    <div class="p-4 rounded-xl border border-slate-700 bg-slate-800/50 peer-checked:bg-purple-600 peer-checked:border-purple-500 peer-checked:text-white text-slate-400 transition-all text-center h-full">
                                        <div class="font-bold text-sm mb-1">Counsellor AI</div>
                                        <div class="text-[10px] opacity-70">Guidance & Support</div>
                                    </div>
                                </label>
                            </div>
                            <select id="new-chat-mode" class="hidden">
                                <option value="therapy">Therapy AI</option>
                                <option value="counsellor">Counsellor AI</option>
                            </select>
                        </div>
                        <div class="flex gap-3 pt-2">
                            <button type="button" onclick="closeNewChatModal()" class="flex-1 py-4 rounded-xl border border-slate-600 text-slate-300 hover:bg-slate-800 hover:text-white transition-colors font-medium">Cancel</button>
                            <button type="submit" class="btn-premium flex-1 py-4 rounded-xl text-white font-bold hover:brightness-110 transition-all">Start Chat</button>
                        </div>
                    </form>
                </div>
            </div>
        ` : ''}
    `;
}

window.addEventListener('DOMContentLoaded', async () => {
    console.log('üåê DOM Content Loaded');
    console.log('üîç Checking for existing tokens...');
    
    if (localStorage.getItem('access_token')) {
        console.log('‚úÖ Tokens found');
        state.isAuthenticated = true;
        
        try {
            const needsConsent = await api.checkServerConsent();
            
            if (needsConsent) {
                console.log('‚ö†Ô∏è Server says consent needed');
                state.showConsent = true;
                render();
            } else {
                console.log('‚úÖ Server says consent valid, initializing app...');
                await initializeApp();
            }
        } catch (e) {
            console.log('‚ùå Session invalid or check failed');
            handleLogout();
        }
    } else {
        console.log('‚ÑπÔ∏è No tokens found, showing login');
        render();
    }
});
    </script>
</body>
</html>